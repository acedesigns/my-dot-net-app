@model MyApi.Models.Post
@{
    Layout = "_Layout";
    ViewData["Title"] = "Posts";
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
<div class="container mt-4">
    <div class="row justify-content-md-center">
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">@Model.Title</h2>
                    <p class="text-muted"></p>
                        by 
                        <a asp-controller="Posts" asp-action="ByAuthor" asp-route-id="@Model.UserId">
                            @Model.User?.Username
                        </a>
                        on @Model.CreatedAt.ToString("dd MMM yyyy")
                    </p>

                    <p class="card-text">@Model.Content</p>

                    <p class="card-text">
                        Likes: @(Model.Likes?.Count ?? 0)
                    </p>

                    <form method="post" asp-action="Like" asp-route-id="@Model.Id">
                        <button type="submit" class="btn btn-primary btn-sm">Like</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="mt-4">
                <h4>Comments (@Model.Comments.Count)</h4>

                @if (Model.Comments.Any()) {
                    <ul class="list-group">
                        @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt)) {
                            <li class="list-group-item">
                                <strong>@(comment.User?.Username ?? "Unknown"):</strong>
                                
                                <p>@comment.Content</p>
                                
                                <small class="text-muted">@comment.CreatedAt.ToLocalTime().ToString("dd MMM yyyy HH:mm")</small>
                            </li>
                        }
                    </ul>
                } else {
                    <p>No comments yet.</p>
                }

                @* Comment form for logged-in users *@
                @if (User.Identity?.IsAuthenticated == true) {
                    <form asp-action="AddComment" method="post" class="mb-3 mt-3">
                        <input type="hidden" name="postId" value="@Model.Id" />
                        <div class="mb-3">
                            <textarea name="content" class="form-control" rows="3" placeholder="Write a comment..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Comment</button>
                    </form>
                } else {
                    <p class="mt-4"><a href="/Auth/Login">Log in</a> to add a comment.</p>
                }
            </div>
        </div>
    </div>
</div>